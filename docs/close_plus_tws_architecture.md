# Architectuurwijzigingen voor close + TWS-bid/ask stroom

Deze notitie beschrijft welke componenten in de huidige Tomic-stack we moeten uitbreiden om **close-data als baseline** te gebruiken, terwijl we TWS snapshots inzetten zodra live bid/ask beschikbaar komt. Het doel is tweeledig: voorstellen blijven zichtbaar bij gesloten markten én we maken meteen duidelijk dat scores op previewkwaliteit gebaseerd zijn totdat een TWS-refresh loopt.

## 1. Baseline spot- en close-data
- **Close ophalen en dateren.** `tomic/helpers/price_utils._load_latest_close` levert nu al een tuple `(prijs, datum)` terug. Deze functie is de bron voor fallback-spotprijzen wanneer er geen intraday quotes zijn; we moeten de returnwaarde uitbreiden met een expliciete bron/timestamp zodat downstream logica de leeftijd kan tonen.
- **Metadata rond close-fetches.** `tomic/helpers/price_meta.load_price_meta` bewaakt wanneer er voor het laatst bars zijn opgehaald. Zodra we closes als baseline promoten, moet dit bestand aangeven dat de close momenteel als “primary mid seed” dient. Zo kan de scan-service zien of de baseline al overeenkomt met de meest recente handelsdag.
- **Spot-resolutie voor scans.** `tomic/services/chain_processing.resolve_spot_price` bepaalt in welke volgorde we spotprijzen proberen: TWS refresh, metrics-cache, close en desnoods de keten zelf. Dit is het ankerpunt om expliciet te loggen wanneer we op een close fallbacken en om het onderscheid tussen “live” en “close” aan de UI door te geven.
- **Gebruik binnen de marktscan.** `tomic/services/market_scan_service.MarketScanService.run_market_scan` groepeert symbolen, laadt één keer de optieketen en hergebruikt dezelfde close/spot-waardes voor alle strategieën. Hier kunnen we toevoegen dat elke `ScanRow` een vlag meekrijgt zodra de spot uit `_load_latest_close` komt, zodat het controlpanel meteen de previewstatus toont.

## 2. Option-chain normalisatie & mid-metadata
- **Ketenvoorbereiding.** `tomic/services/chain_processing.load_and_prepare_chain` verzorgt het normaliseren van CSV-ketens voordat de pipeline ze ziet. Een logregel of veld kan benadrukken dat alle `close` kolommen behouden moeten blijven omdat `MidResolver` ze als laatste redmiddel gebruikt.
- **MidResolver als centrale waarheid.** `tomic/mid_resolver.MidResolver` verrijkt elke optie met `mid`, `mid_source`, `mid_reason`, `spread_flag` en optioneel `mid_fallback`. Het algoritme probeert achtereenvolgens echte bid/ask, put-call parity, modelprijzen en ten slotte de close. Hierdoor hebben we één plaats om de bronlabeling en refresh-behoefte te beheren.
- **Labelen, niet beslissen.** `MidResolver` blijft beperkt tot het labelen van `mid_source` en het annoteren van `mid_reason`. Limieten op het aantal previewlegs verdwijnen hier; de resolver exposeert uitsluitend metadata zodat downstream-componenten beslissingen nemen.

## 3. Strategie-scoringspijplijn
- **MidResolver integratie.** `tomic/services/strategy_pipeline.StrategyPipeline.build_proposals` bouwt eerst een `MidResolver` en werkt met de verrijkte keten. Dit is de juiste plaats om voorstellen met preview-mids een zachte penalty of label te geven in plaats van ze af te wijzen.
- **Samenvattingen van bronnen.** Tijdens `_convert_proposal` wordt `fallback_summary` opgebouwd en tellen we hoeveel legs per bron zijn gebruikt. Deze data voedt het controlpanel zodat gebruikers zien of een setup volledig op closes draait.
- **Scoringsregels voor fallbacks.** `tomic/analysis/scoring` krijgt een config-gedreven limiet (`fallback_penalty_config`) waarmee we voorstellen met `close`/`parity_close` legs een penalty en status `advisory` geven. Alleen wanneer een harde inhoudelijke regel faalt volgt een echte reject.
- **Reason-taxonomie centraal.** Een kleine helper, bijvoorbeeld `tomic/strategy/reason_mapper`, bewaart de mapping van `mid_source` naar `ReasonDetail`. Zowel scoring als UI gebruiken deze helper zodat “Overig” niet meer verschijnt zolang er labels zijn.
- **Controlpanel-weergave.** `tomic/services/portfolio_service.PortfolioService._mid_sources` vat alle `mid_source` waarden samen per voorstel. Hiermee kunnen we in het panel het label “close/parity preview” laten zien in plaats van “Top reason: Overig (100%)”.
- **Publicatiestaten.** Scoring publiceert precies drie staten naar portfolio/CLI: `tradable` (genoeg true bid/ask), `advisory` (close/parity) en `rejected` (inhoudelijke breach). Geen extra varianten, zodat de CLI helder blijft.

## 4. TWS-refresh & herwaardering
- **Snapshot toepassen.** `tomic/services/ib_marketdata.IBMarketDataService._apply_snapshot` overschrijft mids, verwijdert fallback-tags en markeert de bron als `true` zodra een IB-quote binnenkomt. Hier loggen we de delta tussen close en live, herwaarderen EV/RR/score en vergelijken we met een configureerbare drempel `close_dev_pct`. Grote afwijking triggert een waarschuwing, geen automatische reject.
- **Handmatige refresh.** `tomic/services/ib_marketdata.fetch_quote_snapshot` biedt een entrypoint om één voorstel interactief te updaten – precies wat we nodig hebben wanneer de gebruiker vanuit het panel op een individuele leg klikt. De CLI toont in dit geval een badge “needs refresh” totdat een snapshot verwerkt is.
- **Batch-refresh (bijvoorbeeld optie 999).** `tomic/services/pipeline_refresh.refresh_pipeline` verwerkt een lijst aan afgewezen of preview-voorstellen, voert `fetch_quote_snapshot` uit (eventueel parallel) en schrijft de uitkomst weg met behoud van de oorspronkelijke index. Rate-limits, timeouts en retries komen uit één gedeelde config (`refresh_throttling`) zodat we IB-errors vermijden. Deze bouwsteen gebruiken we om in bulk TWS-data op te halen wanneer de gebruiker een hele scan wil verversen.

## 5. Governance & monitoring
- **Rejection dashboards.** `StrategyPipeline` bewaart `last_rejections` en `last_evaluated`, waarmee we kunnen tellen hoeveel voorstellen in de `advisory` staat blijven hangen. Dit voedt dashboards of alerts zodra de markten openen maar mids niet ververst zijn.
- **Mid-bron rapportage.** De `Candidate` die uit `PortfolioService.rank_candidates` komt bevat `mid_sources`, `score`, en `bid_ask_pct`. Daarmee kunnen we eenvoudig signaleren hoeveel actieve voorstellen nog op `close` draaien en welke eerst een IB-refresh moeten krijgen.
- **Logging en tests.** `tomic/analysis/scoring.validate_leg_metrics` logt expliciet wanneer mids ontbreken of uit fallback komen, en unit-tests bewaken dat preview-mids alleen een penalty krijgen. Integration-tests behandelen de transitie `advisory → tradable` na refresh, en regression-tests bewaken dat `Top reason` nooit meer `Overig` toont zodra labels aanwezig zijn.

Met deze actuele verwijzingen kunnen we gericht wijzigingen plannen: close-data promoten tot officiële baseline, previewvoorstellen zichtbaar houden met duidelijke labeling en vervolgens via `fetch_quote_snapshot` of `refresh_pipeline` snel opschalen naar echte TWS-mids zodra de markt opent. De mini-roadmap is eenvoudig: (1) MidResolver labelt alleen, (2) scoring voegt penalty + `advisory` staat toe zonder harde reject, (3) CLI toont de badge “needs refresh” en start de refresh + herwaardering.
